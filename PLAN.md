# add-status

A lightweight CLI tool for bulk updating the "Current Status" field on Jira RM tickets.

## Background

The Jira MCP server does not currently support writes to custom fields like "Current Status" (see [devtools MR #3664](https://gitlab.cfdata.org/cloudflare/mono/devtools/-/merge_requests/3664#note_6833693)). This tool uses the Jira REST API directly to fill that gap.

## Installation

```bash
# From the project directory
cd status-updates-reminder
npm install
npm run build
npm install -g .

# Now available globally
add-status --help
```

## Prerequisites

Requires `cloudflared` to be installed for authentication.

## CLI Usage

### Authentication

```bash
# Authenticate with Jira (valid for 24h)
add-status auth
```

### Updating Tickets

```bash
# Basic usage - update your team's in-progress RM tickets
add-status "Completed code review, awaiting deploy"

# With custom JQL query
add-status "On track" --jql "project = RM AND assignee = currentUser()"

# Dry-run mode (preview only, no prompts, no changes)
add-status "My update" --dry-run

# Skip auto date prefix (if you want custom formatting)
add-status "2026-01-27: Custom format" --no-date-prefix
```

### Default JQL Query

```
project = RM AND teams in ("Workers Authoring & Testing") AND status = "In Progress"
```

## Behavior

| Mode | Description |
|------|-------------|
| **Default (interactive)** | For each ticket: show current status, proposed change, prompt `[y/n/skip all/apply all]` |
| **`--dry-run`** | Show all proposed changes, no prompts, no updates applied |

## Update Logic

1. Fetch ticket's current "Current Status" field value
2. If empty → set to `YYYY-MM-DD: <your status>`
3. If has content → prepend `YYYY-MM-DD: <your status>\n` to existing content
4. If `--no-date-prefix` is set → use status string as-is (no date prepended)

### Example

**Before:**
```
2026-01-20: Completed initial review
```

**After running `add-status "Addressed feedback, ready for final review"`:**
```
2026-01-27: Addressed feedback, ready for final review
2026-01-20: Completed initial review
```

## CLI Summary

| Command | Description |
|---------|-------------|
| `add-status auth` | Authenticate with Jira via cloudflared |
| `add-status "<text>"` | Update tickets with default JQL |
| `add-status "<text>" --jql "..."` | Update tickets with custom JQL |
| `add-status "<text>" --dry-run` | Preview only, no changes |
| `add-status "<text>" --no-date-prefix` | Skip `YYYY-MM-DD:` prefix |

## Project Structure

```
status-updates-reminder/
├── src/
│   ├── index.ts          # CLI entry point (#!/usr/bin/env node)
│   ├── jira.ts           # Jira API client (search, update, get fields)
│   ├── auth.ts           # cloudflared token retrieval
│   └── types.ts          # TypeScript types
├── dist/                 # Compiled JS (generated by build)
├── package.json          # bin: { "add-status": "./dist/index.js" }
├── tsconfig.json
└── PLAN.md
```

## Dependencies

- `commander` - CLI argument parsing
- `chalk` - Colored terminal output
- `ora` - Loading spinners

## Authentication Details

The tool uses Cloudflare Access for authentication:

1. `add-status auth` runs `cloudflared access login https://jira.cfdata.org`
2. This opens a browser for Cloudflare Access authentication
3. Generates a JWT token valid for **24 hours**
4. Subsequent commands retrieve the token via `cloudflared access token https://jira.cfdata.org`
5. API requests use the `cf-access-token` header

## Jira API Endpoints Used

1. **Get fields** - `GET /rest/api/latest/field` → find custom field ID for "Current Status"
2. **Search tickets** - `GET /rest/api/2/search?jql=...`
3. **Get ticket** - `GET /rest/api/2/issue/{key}` → fetch current field values
4. **Update ticket** - `PUT /rest/api/2/issue/{key}` → update custom field
